name: CD - Deploy para VPS (Locaweb)

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # Permite executar manualmente

env:
  PHP_VERSION: '8.2'

jobs:
  deploy:
    name: ğŸš€ Deploy para VPS
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ˜ Configurar PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          tools: composer:v2

      - name: ğŸ“¦ Instalar dependÃªncias de produÃ§Ã£o
        run: composer install --no-dev --optimize-autoloader --no-interaction

      - name: ğŸ” Configurar chave SSH
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          # Salvar chave privada preservando quebras de linha corretamente
          # Usar printf para garantir que as quebras de linha sejam preservadas
          printf '%s\n' "${{ secrets.VPS_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          # Verificar se a chave foi salva corretamente
          if [ ! -s ~/.ssh/id_rsa ]; then
            echo "âŒ Erro: Chave SSH vazia ou nÃ£o foi salva corretamente"
            exit 1
          fi
          # Verificar formato da chave
          if ! grep -q "BEGIN.*PRIVATE KEY" ~/.ssh/id_rsa; then
            echo "âŒ Erro: Formato da chave SSH invÃ¡lido"
            exit 1
          fi
          echo "âœ… Chave SSH configurada com sucesso"
          # Adicionar host ao known_hosts
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true
          chmod 644 ~/.ssh/known_hosts
          
      - name: ğŸ“‹ Verificar conexÃ£o SSH
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} "echo 'âœ… ConexÃ£o SSH estabelecida'"

      - name: ğŸ—‚ï¸ Criar backup do cÃ³digo atual
        run: |
          ssh ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'EOF'
            if [ -d "${{ secrets.VPS_PATH }}" ]; then
              BACKUP_DIR="${{ secrets.VPS_PATH }}_backup_$(date +%Y%m%d_%H%M%S)"
              echo "ğŸ“¦ Criando backup em: $BACKUP_DIR"
              cp -r "${{ secrets.VPS_PATH }}" "$BACKUP_DIR"
              echo "âœ… Backup criado com sucesso!"
            fi
          EOF

      - name: ğŸš€ Deploy via rsync
        run: |
          rsync -avz --delete \
            --exclude '.git' \
            --exclude '.github' \
            --exclude 'tests' \
            --exclude 'vendor' \
            --exclude 'node_modules' \
            --exclude '.env' \
            --exclude 'coverage' \
            --exclude '.docker' \
            --exclude 'docker-compose.yml' \
            --exclude 'Dockerfile' \
            --exclude 'DEVOPS.md' \
            --exclude 'README.md' \
            --exclude 'MINHA_CHAVE_SSH.txt' \
            ./ ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:${{ secrets.VPS_PATH }}

      - name: ğŸ“¦ Instalar dependÃªncias no servidor
        run: |
          ssh ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'EOF'
            cd ${{ secrets.VPS_PATH }}
            
            echo "ğŸ“¦ Instalando dependÃªncias do Composer..."
            /usr/local/bin/composer install --no-dev --optimize-autoloader --no-interaction || composer install --no-dev --optimize-autoloader --no-interaction
            
            echo "ğŸ”’ Configurando permissÃµes..."
            chmod -R 755 .
            mkdir -p logs
            chmod -R 777 logs
            
            echo "âœ… DependÃªncias instaladas!"
          EOF

      - name: ğŸ—„ï¸ Executar migraÃ§Ãµes do banco de dados
        run: |
          ssh ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'EOF'
            cd ${{ secrets.VPS_PATH }}
            
            # Se vocÃª tiver um script de migraÃ§Ã£o, execute aqui
            # php migrate.php
            
            echo "âœ… MigraÃ§Ãµes executadas (se aplicÃ¡vel)"
          EOF

      - name: ğŸ”„ Reiniciar serviÃ§os (se necessÃ¡rio)
        run: |
          ssh ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'EOF'
            # Reiniciar PHP-FPM se estiver usando
            # sudo systemctl restart php8.2-fpm
            
            # Reiniciar Nginx se necessÃ¡rio
            # sudo systemctl reload nginx
            
            echo "âœ… ServiÃ§os reiniciados!"
          EOF

      - name: ğŸ§¹ Limpar backups antigos (manter Ãºltimos 5)
        run: |
          ssh ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'EOF'
            BACKUP_BASE="${{ secrets.VPS_PATH }}_backup_"
            PARENT_DIR="$(dirname ${{ secrets.VPS_PATH }})"
            cd "$PARENT_DIR" 2>/dev/null || exit 0
            ls -dt ${BACKUP_BASE}* 2>/dev/null | tail -n +6 | xargs rm -rf 2>/dev/null || true
            echo "âœ… Backups antigos limpos!"
          EOF

      - name: âœ… Verificar deploy
        run: |
          ssh ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'EOF'
            cd ${{ secrets.VPS_PATH }}
            echo "ğŸ“‚ ConteÃºdo do diretÃ³rio:"
            ls -la
            echo ""
            echo "ğŸ˜ VersÃ£o do PHP:"
            php -v | head -n 1
            echo ""
            echo "âœ… Deploy concluÃ­do com sucesso!"
          EOF

      - name: ğŸ“Š Criar resumo do deploy
        if: always()
        run: |
          echo "## ğŸš€ Deploy para VPS" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Status:** ConcluÃ­do" >> $GITHUB_STEP_SUMMARY
          echo "ğŸŒ **Servidor:** ${{ secrets.VPS_HOST }}" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ“‚ **DiretÃ³rio:** ${{ secrets.VPS_PATH }}" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ• **Data:** $(date '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ‘¤ **Autor:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ“ **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY

  rollback:
    name: ğŸ”„ Rollback (Manual)
    runs-on: ubuntu-latest
    if: failure()
    needs: deploy
    
    steps:
      - name: ğŸ”„ InstruÃ§Ãµes de Rollback
        run: |
          echo "## âš ï¸ Deploy Falhou!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Para fazer rollback manual, execute no servidor:" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "# Listar backups disponÃ­veis" >> $GITHUB_STEP_SUMMARY
          echo 'ls -lah ${{ secrets.VPS_PATH }}_backup_*' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Restaurar Ãºltimo backup" >> $GITHUB_STEP_SUMMARY
          echo 'LAST_BACKUP=$(ls -dt ${{ secrets.VPS_PATH }}_backup_* | head -n 1)' >> $GITHUB_STEP_SUMMARY
          echo 'rm -rf ${{ secrets.VPS_PATH }}' >> $GITHUB_STEP_SUMMARY
          echo 'cp -r $LAST_BACKUP ${{ secrets.VPS_PATH }}' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
