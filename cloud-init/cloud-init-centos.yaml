#cloud-config
# Script Cloud-Init para CentOS/RHEL/Rocky Linux
# Este script configura automaticamente o servidor VPS para o projeto

hostname: aula7-vps
manage_etc_hosts: true

users:
  - name: deploy
    groups: wheel
    shell: /bin/bash
    sudo: ['ALL=(ALL) NOPASSWD:ALL']
    lock_passwd: false
    passwd: $6$rounds=4096$salt1234567890$hashed_password_here
    ssh_authorized_keys:
      - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQDAiucb5+/lHBgbwIPLUzdQZYgee5Lh/46YIUkjHDJzVm3R0z9CTFoLaSHxATSvve0/0GMu+b7E0Jyqd0/u4TUDq1fm2/Z+b9hnwt1kNOBEL9ni6KaPbW3g/qnqKLkRWDU6hBryauXDBVOXJ2Fp4er+Q6/GMejLBoNF3vBkDghh4liw9m/9eGXxal3+5DKU57A3bZH9k56jovYwVemZ3aEU3pScFgfDI3NU1IqC86/sAVDh10Z6V8jykIPc/qy2iyvREqp+f0zGNhobWHObYJTnXeyHU5TDcEh0iQT6oQVmuMgu9DGCNHSqnI7fYJrPJTNiEFaAybNTyTRKklRBzahJkE/dt0vc2Bgp23YgqfdfFk4Wsc6ychT8RFNkn3iZSGkh1WuYiVMtbBVFMXaCyvL1cOvoQ9+I442Y/LXDsJu1ivfZOr7eU/aHQqgvS7zx0+E1FKn7IN6uXwK4ggQ8p5Z5Zyd8qqRhqXSd+OUAG2m/uw9l2j2V3ao08mWn+wrnfCmQeYmePjMZ0Jrq6YRcjjBkevKp4VLlQSoeHqJ5lv7dyh0fYzu42AOJZQRhjC4VbWrg43FLxxPqmIBcmDSnpKfC0dgdVx/jzIn0I+hFRBOPcOsrOu9kcEcDYesRf/hNQALnUrIMNLgYkRVC1vslujbGg2aiEr//h8bbNd96oa0F5Q== aula7-vps-20251105

package_update: true
package_upgrade: true

packages:
  - curl
  - wget
  - git
  - unzip
  - firewalld
  - fail2ban
  - epel-release

runcmd:
  # Adicionar reposit√≥rios
  - yum install -y https://dl.fedoraproject.org/pub/epel/epel-release-latest-8.noarch.rpm
  - yum install -y https://rpms.remirepo.net/enterprise/remi-release-8.rpm
  
  # Instalar PHP 8.2
  - yum module reset php -y
  - yum module enable php:remi-8.2 -y
  - yum install -y php php-fpm php-mysqlnd php-mbstring php-xml php-curl php-zip php-gd
  
  # Instalar Nginx
  - yum install -y nginx
  
  # Instalar MySQL/MariaDB
  - yum install -y mariadb-server mariadb
  - systemctl enable mariadb
  - systemctl start mariadb
  
  # Configurar MySQL
  - |
    mysql -u root <<EOF
    CREATE DATABASE IF NOT EXISTS aula_php_mvc CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
    CREATE USER IF NOT EXISTS 'app_user'@'localhost' IDENTIFIED BY 'senha_forte_db_aqui';
    GRANT ALL PRIVILEGES ON aula_php_mvc.* TO 'app_user'@'localhost';
    FLUSH PRIVILEGES;
    EOF
  
  # Instalar Composer
  - curl -sS https://getcomposer.org/installer | php
  - mv composer.phar /usr/local/bin/composer
  - chmod +x /usr/local/bin/composer
  
  # Criar diret√≥rios
  - mkdir -p /var/www/aula7
  - mkdir -p /var/www/aula7/logs
  - chown -R deploy:nginx /var/www/aula7
  - chmod -R 755 /var/www/aula7
  - chmod -R 775 /var/www/aula7/logs
  
  # Configurar Nginx
  - |
    cat > /etc/nginx/conf.d/aula7.conf <<'NGINX_CONFIG'
    server {
        listen 80;
        server_name _;
        root /var/www/aula7;
        index index.php;

        access_log /var/log/nginx/aula7_access.log;
        error_log /var/log/nginx/aula7_error.log;

        location / {
            try_files $uri $uri/ /index.php?$query_string;
        }

        location ~ \.php$ {
            fastcgi_pass 127.0.0.1:9000;
            fastcgi_index index.php;
            fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
            include fastcgi_params;
        }

        location ~ /\. {
            deny all;
        }
    }
NGINX_CONFIG
  
  # Configurar PHP-FPM
  - sed -i 's/user = apache/user = nginx/' /etc/php-fpm.d/www.conf
  - sed -i 's/group = apache/group = nginx/' /etc/php-fpm.d/www.conf
  - sed -i 's/listen = 127.0.0.1:9000/listen = 127.0.0.1:9000/' /etc/php-fpm.d/www.conf
  
  # Configurar firewall
  - systemctl enable firewalld
  - systemctl start firewalld
  - firewall-cmd --permanent --add-service=ssh
  - firewall-cmd --permanent --add-service=http
  - firewall-cmd --permanent --add-service=https
  - firewall-cmd --reload
  
  # Configurar Fail2Ban
  - systemctl enable fail2ban
  - systemctl start fail2ban
  
  # Iniciar servi√ßos
  - systemctl enable php-fpm
  - systemctl enable nginx
  - systemctl start php-fpm
  - systemctl start nginx

timezone: America/Sao_Paulo

final_message: |
  ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
  ‚ïë   Servidor CentOS/RHEL configurado com sucesso!             ‚ïë
  ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
  
  ‚úÖ PHP 8.2 instalado
  ‚úÖ MariaDB instalado e configurado
  ‚úÖ Nginx instalado e configurado
  ‚úÖ Composer instalado
  ‚úÖ Firewall configurado
  
  üìÅ Diret√≥rio: /var/www/aula7
  üë§ Usu√°rio: deploy

